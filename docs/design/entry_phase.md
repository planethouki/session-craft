# ENTRYフェーズ設計

## 概要
`ENTRY`フェーズでは、`SUBMISSION`フェーズで提出された曲に対して、各メンバーが自分が弾きたい曲とパートを表明します。
重複してのエントリーも許可されます。

## データ構造設計

### Entry コレクション
各曲への各ユーザーのエントリー情報を管理します。

- コレクション名: `entries`
- ドキュメントID: `{sessionId}_{submissionUserId}_{entryUserId}`
  - ※ 1曲に対して1ユーザーが複数パートをエントリーする可能性を考慮し、パートごとに分けるか、1ドキュメントに含めるかを検討。
  - シンプルさのため、1つの曲×ユーザーのペアで1ドキュメントとし、その中で複数のパートを保持する設計とする。

```typescript
type Entry = {
  sessionId: string;
  submissionUserId: string; // 曲を提出したユーザーID
  userId: string;           // エントリーしたユーザーID
  parts: InstrumentalPart[]; // エントリーしたパートのリスト
  createdAt: Date;
  updatedAt: Date;
}
```

### 提出情報の自動エントリー
`SUBMISSION`フェーズで自分の楽器として提出したものは、自動的にこの`Entry`データとして作成される、または`ENTRY`フェーズのリスト表示時に補完されます。
一貫性のため、`SUBMISSION`完了時に、提出者本人分の`Entry`ドキュメントを自動作成する運用とします。

## LINEボット UI/UXフロー

### 1. 曲一覧の表示と選択
30曲程度の曲数が想定されるため、1つのFlex Messageに全ての曲とボタンを詰め込むのではなく、以下の工夫を行います。

#### A. コンパクトな一覧表示と番号選択
- 曲一覧はテキスト、または非常にコンパクトなFlex Message（1行1曲程度）で表示します。
- 各曲には通し番号（1, 2, 3...）を振ります。
- ユーザーは「1」「エントリー 1」のように番号を直接入力することで、対象の曲を選択します。
- キーボード入力を補助するため、番号を選択するQuick Replyを提示します。

#### B. ページネーション（分割表示）
- 10曲程度ごとに分割して表示します。「次へ」「前へ」ボタンで表示を切り替えられるようにします。

### 2. 曲の選択と詳細確認
番号入力などで曲が指定された際、その曲の「詳細情報（音源URL等）」と「パート選択ボタン」を含むFlex Messageを1通送信します。
これにより、UIの長大化を防ぎつつ、必要な情報を確認した上でエントリーできるようにします。

### 3. パート選択
詳細画面に表示されたパート一覧から、自分が弾きたいパートを選択します（複数選択可）。
選択状況をリアルタイムに反映するため、Flex Message内のボタン（Postbackアクション）を活用します。

### 4. エントリー完了
「この内容で確定」ボタンを押すことで、`entries` コレクションに保存されます。
保存完了後、現在の自分のエントリー状況を一覧で確認できるメッセージを表示します。

## ユーザー状態（UserState）の追加
`ENTRY`フェーズの対話を管理するために、以下の状態を`UserState`に追加します。

- `SELECT_ENTRY_PART`: どのパートにエントリーするか選択中の状態。

## 実装上の考慮点
- **重複エントリーの許可**: 同じパートに複数人がエントリーしてもエラーにしない。
- **自動エントリーの同期**: `SUBMISSION`で提出された曲の`myParts`が変更された場合、対応する`Entry`も更新する必要がある。
- **募集外パートのエントリー**: 基本は`Submission.parts`にあるもののみとするが、「その他」などでの対応を検討。

## 次のステップ
1. `Entry`型の定義追加
2. `firestoreService.ts` への `Entry` 操作関数の追加
3. `botService.ts` での `ENTRY` 状態のハンドリング追加
4. `src/services/bot/entry.ts` の新規作成
