rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    function isSignedIn() { return request.auth != null; }
    function isSelf(uid) { return isSignedIn() && request.auth.uid == uid; }
    function userDoc(uid) { return get(/databases/$(database)/documents/users/$(uid)); }
    function hasRole(role) { return isSignedIn() && (role in userDoc(request.auth.uid).data.roles); }
    function isApproved() { return isSignedIn() && userDoc(request.auth.uid).data.approved == true; }

    match /users/{uid} {
      allow read: if isSelf(uid) || hasRole('admin') || hasRole('partLeader');
      allow write: if false;
    }

    match /sessions/{sessionId} {
      allow read: if isSignedIn() && isApproved();
      allow write: if false;

      match /proposals/{proposalId} {
        allow read: if isSignedIn() && isApproved();
        allow write: if false;
      }

      match /entries/{entryId} {
        allow read: if isSignedIn() && isApproved();
        allow write: if false;
      }
    }
  }
}
